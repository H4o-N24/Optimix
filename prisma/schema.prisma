generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

/// Discordサーバー設定
model Guild {
  id            String   @id @default(cuid())
  guildId       String   @unique @map("guild_id")
  botChannelId  String?  @map("bot_channel_id") // Knot専用チャンネルID（nullなら制限なし）
  planType      String   @default("FREE") @map("plan_type") // FREE, PRO, TEAM
  timezone      String   @default("Asia/Tokyo")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  availabilities Availability[]
  events         Event[]

  @@map("guilds")
}

/// Discordユーザー情報
model User {
  id               String   @id @default(cuid())
  userId           String   @unique @map("user_id") // Discord User ID
  discordTag       String   @map("discord_tag")
  stripeCustomerId String?  @map("stripe_customer_id")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  availabilities    Availability[]
  eventRequirements EventRequirement[]
  eventParticipants EventParticipant[]

  @@map("users")
}

/// 空き日情報
model Availability {
  id      String @id @default(cuid())
  userId  String @map("user_id")
  guildId String @map("guild_id")
  date    String // YYYY-MM-DD 形式
  status  String @default("AVAILABLE") // AVAILABLE, BUSY, TENTATIVE

  user  User  @relation(fields: [userId], references: [userId])
  guild Guild @relation(fields: [guildId], references: [guildId])

  @@unique([userId, guildId, date])
  @@map("availabilities")
}

/// イベント情報
model Event {
  id              String   @id @default(cuid())
  guildId         String   @map("guild_id")
  title           String
  description     String?
  date            String?  // 確定日 (YYYY-MM-DD)
  minParticipants Int      @default(1) @map("min_participants")
  maxParticipants Int?     @map("max_participants")
  status          String   @default("PLANNING") // PLANNING, CONFIRMED, CANCELLED, COMPLETED
  channelId       String?  @map("channel_id")
  messageId       String?  @map("message_id")
  createdBy       String   @map("created_by") // Discord User ID
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  guild        Guild              @relation(fields: [guildId], references: [guildId])
  requirements EventRequirement[]
  participants EventParticipant[]

  @@map("events")
}

/// 必須メンバー
model EventRequirement {
  id             String @id @default(cuid())
  eventId        String @map("event_id")
  requiredUserId String @map("required_user_id")

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [requiredUserId], references: [userId])

  @@unique([eventId, requiredUserId])
  @@map("event_requirements")
}

/// 参加者（先着順管理）
model EventParticipant {
  id       String   @id @default(cuid())
  eventId  String   @map("event_id")
  userId   String   @map("user_id")
  status   String   @default("CONFIRMED") // CONFIRMED, WAITLISTED, CANCELLED
  joinedAt DateTime @default(now()) @map("joined_at")

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [userId])

  @@unique([eventId, userId])
  @@map("event_participants")
}
